import React, { useState, useEffect, useRef } from 'react';
import { ChevronLeft, ChevronRight, Calendar, Inbox, ZoomIn, ZoomOut, AlertCircle, RefreshCw } from 'lucide-react';

/**
* ------------------------------------------------------------------
* é…ç½®ä¸å¸¸é‡
* ------------------------------------------------------------------
*/

// ä¸»é¢˜è‰²ï¼šæ©™é»„è‰² (å‚è€ƒ iOS Calendar çš„ Orange)
const THEME_COLOR = '#FF9F0A';
const THEME_BG_COLOR = '#FFF4E5'; // æµ…è‰²èƒŒæ™¯

// ç›®æ ‡æ—¥å† URL
const CALENDAR_URL = "webcal://p229-caldav.icloud.com.cn/published/2/MTYyOTg3NjY1NDExNjI5OO16cwF0wRes6xO2XO29_OCn8TwNIIofKRbNMJEIjR0IfrBR7W_YaoOPol64XPKolKvp17XfUHDCCv4BZ-MFqfA";

// CORS ä»£ç†æœåŠ¡
// æ³¨æ„ï¼šå¦‚æœä½ åœ¨ Netlify ä¸Šéƒ¨ç½²ï¼Œå»ºè®®åˆ›å»ºä¸€ä¸ª Netlify Function æ¥åšä»£ç†ï¼Œæ¯”ä½¿ç”¨å…¬å…±ä»£ç†æ›´ç¨³å®šã€‚
// è¿™é‡Œæš‚æ—¶ä½¿ç”¨å…¬å…±ä»£ç†ä»¥ç¡®ä¿å½“å‰é¢„è§ˆå¯ç”¨ã€‚
const CORS_PROXY = "https://api.allorigins.win/raw?url=";

/**
* ------------------------------------------------------------------
* ICS è§£æé€»è¾‘
* ------------------------------------------------------------------
*/
const parseICS = (icsData) => {
 const events = [];
 const lines = icsData.split(/\r\n|\n|\r/);
 let currentEvent = null;

 const parseDate = (dateStr) => {
   if (!dateStr) return null;
   // å¤„ç†å½¢å¦‚ 20251129T120000Z çš„å­—ç¬¦ä¸²
   const year = parseInt(dateStr.substring(0, 4));
   const month = parseInt(dateStr.substring(4, 6)) - 1;
   const day = parseInt(dateStr.substring(6, 8));
   
   if (dateStr.length <= 8) {
     return new Date(year, month, day);
   }

   let hour = parseInt(dateStr.substring(9, 11));
   let minute = parseInt(dateStr.substring(11, 13));
   let second = parseInt(dateStr.substring(13, 15));
   
   // æ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰å¤„ç†å¤æ‚çš„æ—¶åŒºè½¬æ¢ï¼Œé»˜è®¤ä¸ºæœ¬åœ°æ—¶é—´è§£æ
   // å®é™…ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ä¸“é—¨çš„åº“å¦‚ 'ical.js'
   return new Date(year, month, day, hour, minute, second);
 };

 for (let line of lines) {
   if (line.startsWith('BEGIN:VEVENT')) {
     currentEvent = {};
   } else if (line.startsWith('END:VEVENT')) {
     if (currentEvent && currentEvent.start) {
        // å¦‚æœæ²¡æœ‰ç»“æŸæ—¶é—´ï¼Œé»˜è®¤1å°æ—¶
        if (!currentEvent.end) {
            currentEvent.end = new Date(currentEvent.start.getTime() + 60 * 60 * 1000);
        }
        events.push(currentEvent);
     }
     currentEvent = null;
   } else if (currentEvent) {
     const parts = line.split(':');
     if (parts.length < 2) continue;
     
     const keyPart = parts[0];
     const value = parts.slice(1).join(':'); // å¤„ç†å€¼ä¸­åŒ…å«å†’å·çš„æƒ…å†µ
     const [key, ...params] = keyPart.split(';');

     switch (key) {
       case 'SUMMARY':
         currentEvent.title = value;
         break;
       case 'DTSTART':
         currentEvent.start = parseDate(value);
         break;
       case 'DTEND':
         currentEvent.end = parseDate(value);
         break;
       case 'LOCATION':
         currentEvent.location = value;
         break;
       case 'DESCRIPTION':
         currentEvent.description = value;
         break;
     }
   }
 }
 return events;
};

/**
* ------------------------------------------------------------------
* ç»„ä»¶éƒ¨åˆ†
* ------------------------------------------------------------------
*/

// é¡¶éƒ¨ç®€æ´å¯¼èˆª
const NavBar = ({ currentDate, view, setView }) => {
 const monthNames = ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"];
 const year = currentDate.getFullYear();
 const month = monthNames[currentDate.getMonth()];

 return (
   <div className="sticky top-0 z-40 bg-white/95 backdrop-blur-md shadow-sm border-b border-gray-100 pt-2 pb-2">
     <div className="px-4 flex items-center justify-between">
       {/* å·¦ä¾§ï¼šåªæ˜¾ç¤ºå½“å‰å¹´æœˆ */}
       <h1 className="text-2xl font-bold text-gray-900 flex items-baseline gap-2">
          {year}å¹´ {month}
       </h1>

       {/* å³ä¾§ï¼šè§†å›¾åˆ‡æ¢ */}
       <div className="flex bg-gray-100 rounded-lg p-0.5 ml-4">
           <button
               onClick={() => setView('month')}
               className={`px-3 py-1.5 text-xs font-medium rounded-md transition-all ${view === 'month' ? 'bg-white shadow-sm text-black' : 'text-gray-500 hover:text-gray-700'}`}
           >
               æœˆ
           </button>
           <button
               onClick={() => setView('day')}
               className={`px-3 py-1.5 text-xs font-medium rounded-md transition-all ${view === 'day' ? 'bg-white shadow-sm text-black' : 'text-gray-500 hover:text-gray-700'}`}
           >
               æ—¥
           </button>
       </div>
     </div>
   </div>
 );
};

// åº•éƒ¨æç®€æ ‡ç­¾æ 
const TabBar = ({ onToday, onRefresh, loading }) => (
 <div className="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-gray-200 h-16 flex items-center justify-around px-6 pb-safe z-50 text-[10px] text-gray-400">
   <button onClick={onToday} className="flex flex-col items-center justify-center gap-1 active:scale-95 transition-transform">
     <div className="w-7 h-7 flex items-center justify-center relative">
       <span className="font-bold text-base text-red-500">ä»Š</span>
     </div>
     <span className="text-red-500 font-medium">ä»Šå¤©</span>
   </button>
   
   <button onClick={onRefresh} disabled={loading} className={`flex flex-col items-center justify-center gap-1 active:scale-95 transition-transform ${loading ? 'opacity-50' : ''}`}>
      <RefreshCw className={`w-6 h-6 ${loading ? 'animate-spin text-gray-400' : 'text-gray-400'}`} />
      <span>åˆ·æ–°</span>
   </button>

   <div className="flex flex-col items-center justify-center gap-1 opacity-40 pointer-events-none">
      <Inbox className="w-6 h-6" />
      <span>æ”¶ä»¶ç®±</span>
   </div>
 </div>
);

// æœˆè§†å›¾
const MonthView = ({ currentDate, events, onSelectDate }) => {
 const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
 const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
 
 const days = Array(firstDayOfMonth).fill(null).concat(
   Array.from({ length: daysInMonth }, (_, i) => new Date(currentDate.getFullYear(), currentDate.getMonth(), i + 1))
 );

 const isToday = (date) => {
   const today = new Date();
   return date && date.toDateString() === today.toDateString();
 };

 const hasEvent = (date) => {
   if (!date) return false;
   return events.some(e => e.start.toDateString() === date.toDateString());
 };

 return (
   <div className="bg-white min-h-[400px] animate-fade-in">
     <div className="grid grid-cols-7 text-center border-b border-gray-100 py-2 mb-2">
       {['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].map((d, i) => (
         <div key={i} className="text-xs text-gray-400 font-medium">{d}</div>
       ))}
     </div>
     <div className="grid grid-cols-7 gap-y-1">
       {days.map((date, idx) => (
         <div
           key={idx}
           className="flex flex-col items-center justify-start h-12 relative cursor-pointer group"
           onClick={() => date && onSelectDate(date)}
         >
           {date && (
             <>
               <div className={`
                 w-8 h-8 flex items-center justify-center rounded-full text-base font-medium mb-0.5 transition-colors
                 ${isToday(date) ? 'bg-red-500 text-white' : 'text-gray-900 group-hover:bg-gray-100'}
               `}>
                 {date.getDate()}
               </div>
               {/* äº‹ä»¶ç‚¹ç»Ÿä¸€ä½¿ç”¨æ©™è‰² */}
               <div className="flex gap-0.5 h-1.5">
                  {hasEvent(date) && <div className="w-1.5 h-1.5 rounded-full" style={{ backgroundColor: THEME_COLOR }}></div>}
               </div>
             </>
           )}
         </div>
       ))}
     </div>
     
     {/* æœˆè§†å›¾ä¸‹æ–¹çš„å½“æ—¥åˆ—è¡¨ */}
     <div className="px-4 py-4 mt-2 border-t border-gray-100">
         <h3 className="text-gray-400 text-xs font-medium mb-3">é€‰ä¸­æ—¥æœŸçš„æ—¥ç¨‹</h3>
         {events
           .filter(e => e.start.toDateString() === currentDate.toDateString())
           .map((e, i) => (
               <div key={i} className="flex mb-3 items-center">
                   <div className="w-14 text-right text-xs text-gray-500 mr-3">
                       {e.allDay ? 'å…¨å¤©' : `${e.start.getHours()}:${e.start.getMinutes().toString().padStart(2, '0')}`}
                   </div>
                   <div className="flex-1 pl-3 border-l-[3px] py-1" style={{ borderColor: THEME_COLOR }}>
                       <div className="text-sm font-semibold text-gray-800">{e.title}</div>
                       {e.location && <div className="text-xs text-gray-400 mt-0.5">{e.location}</div>}
                   </div>
               </div>
           ))}
           {events.filter(e => e.start.toDateString() === currentDate.toDateString()).length === 0 && (
               <div className="text-center text-gray-400 text-sm py-4">æ— æ—¥ç¨‹</div>
           )}
     </div>
   </div>
 );
};

// æ—¥è§†å›¾
const DayView = ({ currentDate, events }) => {
 const scrollRef = useRef(null);
 // é«˜åº¦æ§åˆ¶ state
 const [hourHeight, setHourHeight] = useState(60); // é»˜è®¤ 60px/å°æ—¶

 // æ»šåŠ¨åˆ°å½“å‰æ—¶é—´
 useEffect(() => {
   if (scrollRef.current) {
     const now = new Date();
     // å¦‚æœæŸ¥çœ‹çš„æ˜¯ä»Šå¤©ï¼Œæ»šåŠ¨åˆ°å½“å‰æ—¶é—´ï¼›å¦åˆ™æ»šåŠ¨åˆ°8ç‚¹
     const isTodayView = currentDate.toDateString() === now.toDateString();
     const targetHour = isTodayView ? now.getHours() : 8;
     scrollRef.current.scrollTop = (targetHour * hourHeight) - 100;
   }
 }, [currentDate, hourHeight]); // å½“é«˜åº¦å˜åŒ–æ—¶ä¹Ÿè°ƒæ•´æ»šåŠ¨ä½ç½®ï¼Œå°½é‡ä¿æŒè§†é‡

 const dayEvents = events.filter(e => e.start.toDateString() === currentDate.toDateString());
 const hours = Array.from({ length: 24 }, (_, i) => i);
 const now = new Date();
 const isToday = now.toDateString() === currentDate.toDateString();
 const currentTimeTop = isToday ? ((now.getHours() * 60) + now.getMinutes()) * (hourHeight / 60) : null;

 // è°ƒæ•´é«˜åº¦å‡½æ•°
 const adjustZoom = (delta) => {
   setHourHeight(prev => {
       const newVal = prev + delta;
       return Math.max(30, Math.min(150, newVal)); // é™åˆ¶åœ¨ 30px - 150px ä¹‹é—´
   });
 };

 return (
   <div className="flex-1 overflow-hidden relative bg-white">
     {/* ç¼©æ”¾æ§åˆ¶æ‚¬æµ®æŒ‰é’® */}
     <div className="absolute bottom-6 right-6 z-30 flex flex-col gap-2 bg-white/90 backdrop-blur shadow-lg rounded-full p-1.5 border border-gray-100">
        <button onClick={() => adjustZoom(10)} className="p-2 rounded-full hover:bg-gray-100 active:bg-gray-200 text-gray-600">
           <ZoomIn className="w-5 h-5" />
        </button>
        <div className="h-px w-full bg-gray-200"></div>
        <button onClick={() => adjustZoom(-10)} className="p-2 rounded-full hover:bg-gray-100 active:bg-gray-200 text-gray-600">
           <ZoomOut className="w-5 h-5" />
        </button>
     </div>

     <div className="h-full overflow-y-auto" ref={scrollRef}>
       <div className="relative" style={{ height: `${24 * hourHeight}px` }}>
           {/* æ—¶é—´ç½‘æ ¼ */}
           {hours.map(h => (
           <div key={h} className="absolute w-full border-t border-gray-100 flex" style={{ top: `${h * hourHeight}px` }}>
               <div className="w-14 text-right pr-3 text-[10px] text-gray-400 -mt-1.5 transform translate-y-0 select-none">
                  {h}:00
               </div>
               <div className="flex-1"></div>
           </div>
           ))}

           {/* å½“å‰æ—¶é—´çº¢çº¿ */}
           {currentTimeTop !== null && (
           <div className="absolute w-full z-10 flex items-center pointer-events-none" style={{ top: `${currentTimeTop}px` }}>
               <div className="w-14 pr-2 flex justify-end">
                   <div className="text-[9px] text-red-500 font-bold bg-white px-0.5 rounded">
                       {now.getHours()}:{now.getMinutes().toString().padStart(2, '0')}
                   </div>
               </div>
               <div className="flex-1 h-px bg-red-500 relative">
                   <div className="absolute -left-1 -top-1 w-2 h-2 rounded-full bg-red-500"></div>
               </div>
           </div>
           )}

           {/* äº‹ä»¶æ¸²æŸ“ */}
           {dayEvents.filter(e => !e.allDay).map((e, i) => {
               const startMin = e.start.getHours() * 60 + e.start.getMinutes();
               const endMin = e.end.getHours() * 60 + e.end.getMinutes();
               const durationMin = endMin - startMin;
               
               const top = startMin * (hourHeight / 60);
               const height = Math.max(hourHeight / 2, durationMin * (hourHeight / 60)); // æœ€å°é«˜åº¦

               return (
                   <div
                   key={i}
                   className="absolute left-14 right-2 rounded-md p-1.5 border-l-4 shadow-sm text-xs overflow-hidden cursor-pointer hover:brightness-95 transition-all"
                   style={{
                       top: `${top}px`,
                       height: `${height}px`,
                       backgroundColor: THEME_BG_COLOR,
                       borderLeftColor: THEME_COLOR,
                       color: '#4A3B22' // æ·±æ£•è‰²å­—ä½“ï¼Œä¿è¯åœ¨æµ…æ©™è‰²èƒŒæ™¯ä¸Šçš„å¯¹æ¯”åº¦
                   }}
                   >
                       <div className="font-bold leading-tight mb-0.5">{e.title}</div>
                       <div className="text-[10px] opacity-75">
                           {e.start.getHours()}:{e.start.getMinutes().toString().padStart(2, '0')} -
                           {e.end.getHours()}:{e.end.getMinutes().toString().padStart(2, '0')}
                       </div>
                       {e.location && <div className="text-[10px] opacity-70 truncate mt-1">ğŸ“ {e.location}</div>}
                   </div>
               );
           })}
       </div>
     </div>
   </div>
 );
};

// é”™è¯¯æç¤ºç»„ä»¶
const ErrorState = ({ error, retry }) => (
   <div className="flex flex-col items-center justify-center h-full px-8 text-center text-gray-500">
       <AlertCircle className="w-12 h-12 text-red-400 mb-4" />
       <h3 className="text-lg font-semibold text-gray-800 mb-2">æ— æ³•åŠ è½½æ—¥å†</h3>
       <p className="text-sm mb-6 text-gray-400">{error}</p>
       <button
           onClick={retry}
           className="px-6 py-2 bg-gray-900 text-white rounded-lg text-sm font-medium active:scale-95 transition-transform"
       >
           é‡è¯•
       </button>
       <div className="mt-8 text-xs text-gray-300 max-w-xs">
           æç¤º: è¯·æ£€æŸ¥ WebCal é“¾æ¥æ˜¯å¦æœ‰æ•ˆï¼Œæˆ–ç¡®è®¤æ‚¨çš„ç½‘ç»œå¯ä»¥è®¿é—® iCloud æœåŠ¡å™¨ã€‚
       </div>
   </div>
);

/**
* ------------------------------------------------------------------
* ä¸»å…¥å£
* ------------------------------------------------------------------
*/
export default function AppleCalendarClone() {
 const [currentDate, setCurrentDate] = useState(new Date()); // é»˜è®¤ä»Šå¤©
 const [view, setView] = useState('day'); // é»˜è®¤æ—¥è§†å›¾
 const [events, setEvents] = useState([]);
 const [loading, setLoading] = useState(true);
 const [error, setError] = useState(null);

 const fetchCalendar = async () => {
   setLoading(true);
   setError(null);
   try {
     const httpUrl = CALENDAR_URL.replace('webcal://', 'https://');
     // ä½¿ç”¨ä»£ç†è¯·æ±‚
     const response = await fetch(`${CORS_PROXY}${encodeURIComponent(httpUrl)}`);
     
     if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
     
     const text = await response.text();
     const parsedEvents = parseICS(text);
     
     if (parsedEvents.length === 0) {
         console.warn("Parsed 0 events. ICS content might be empty or format unknown.");
     }
     
     setEvents(parsedEvents);
   } catch (err) {
     console.error("Fetch failed:", err);
     setError(err.message || "è¯·æ±‚è¶…æ—¶æˆ–è¢«æ‹¦æˆª");
   } finally {
     setLoading(false);
   }
 };

 useEffect(() => {
   fetchCalendar();
   // è‡ªåŠ¨åˆ·æ–°æœºåˆ¶ (å¯é€‰ï¼Œæ¯5åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡)
   const interval = setInterval(fetchCalendar, 5 * 60 * 1000);
   return () => clearInterval(interval);
 }, []);

 const handleToday = () => {
     const now = new Date();
     setCurrentDate(now);
     // å¦‚æœéœ€è¦ï¼Œå¯ä»¥å¼ºåˆ¶åˆ‡å›æ—¥è§†å›¾
     setView('day');
 };

 return (
   <div className="flex flex-col h-screen max-w-md mx-auto bg-white shadow-2xl relative text-sans overflow-hidden">
     
     {/* é¡¶éƒ¨å¯¼èˆª */}
     <NavBar
       currentDate={currentDate}
       view={view}
       setView={setView}
     />

     {/* ä¸»å†…å®¹åŒºåŸŸ */}
     <div className="flex-1 overflow-hidden flex flex-col relative pb-16">
       {loading && events.length === 0 ? (
           <div className="flex flex-col items-center justify-center h-full text-gray-400 gap-3">
               <div className="w-8 h-8 border-[3px] border-gray-200 border-t-red-500 rounded-full animate-spin"></div>
               <div className="text-sm font-medium">æ­£åœ¨åŒæ­¥æ—¥å†...</div>
           </div>
       ) : error && events.length === 0 ? (
           <ErrorState error={error} retry={fetchCalendar} />
       ) : (
           <>
               {view === 'month' ? (
                   <MonthView
                       currentDate={currentDate}
                       events={events}
                       onSelectDate={(date) => {
                           setCurrentDate(date);
                           setView('day');
                       }}
                   />
               ) : (
                   <DayView
                       currentDate={currentDate}
                       events={events}
                   />
               )}
           </>
       )}
     </div>

     {/* åº•éƒ¨å¯¼èˆª */}
     <TabBar
       onToday={handleToday}
       onRefresh={fetchCalendar}
       loading={loading}
     />
   </div>
 );
}
